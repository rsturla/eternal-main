name: Generate Image SBOM

inputs:
  image-ref:
    description: 'The image reference to generate the SBOM for'
    required: false
    default: ''
  artifact-name:
    description: 'The name of the artifact to generate the SBOM for'
    required: false
  output-file:
    description: 'The path to the SBOM file'
    required: false
    default: 'syft-sbom.json'
  username:
    description: 'The username to authenticate with the registry.  Defaults to GITHUB_ACTOR'
    required: false
  password:
    description: 'The password to authenticate with the registry.  Defaults to GITHUB_TOKEN'
    required: false

outputs:
  output-file:
    description: 'The path to the SBOM file'
    value: ${{ inputs.output-file }}

runs:
  using: composite
  steps:
    - name: Scan Image
      if: inputs.image-ref != ''
      id: run-syft
      uses: anchore/sbom-action@v0
      with:
        image: ${{ inputs.image-ref }}
        output-file: ${{ inputs.output-file }}
        format: spdx-json
        registry-username: ${{ inputs.username || github.actor }}
        registry-password: ${{ inputs.password || github.token }}
        upload-artifact: false

    - name: Upload SBOM Artifact
      if: inputs.artifact-name != ''
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.artifact-name }}
        path: ${{ inputs.output-file }}
        if-no-files-found: error
        compression-level: 8
