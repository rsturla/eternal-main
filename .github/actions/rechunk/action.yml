name: Rechunk Image

inputs:
  builder:
    description: 'The name of the builder to use (docker or podman)'
    required: false
    default: 'podman'
  ref:
    description: 'The reference to the image to rechunk'
    required: true
  prev-ref:
    description: 'The reference to the previous image'
    required: false
  tags:
    description: 'The tags to apply to the rechunked image'
    required: false
    default: ''

steps:
  - name: Prepare Rechunk
    env:
      SOURCE_IMAGE: ${{ inputs.ref }}
    run: |
      set -euox pipefail
      sudo apt update && sudo apt install systemd-container
      podman image ls
      sudo podman image scp $(whoami)@localhost::${SOURCE_IMAGE} root@localhost::
      sudo podman image ls
      podman rmi $(podman image ls -qa) --force

  - name: Rechunk Image
    id: rechunk
    uses: hhd-dev/rechunk@v0.8.6
    with:
      rechunk: ghcr.io/hhd-dev/rechunk:v0.8.6
      ref: ${{ inputs.ref }}
      skip_compress: true
      prev-ref: ${{ inputs.prev-ref }}

  - name: Load Rechunked Image
    run: |
      sudo podman rmi $(sudo podman image ls -qa) --force
      IMAGE=$(podman pull ${{ steps.rechunk.outputs.ref }})
      sudo rm -rf ${{ steps.rechunk.outputs.output }}
      for tag in ${{ steps.build_image.outputs.tags }}; do
        podman tag $IMAGE ${{ env.IMAGE_NAME }}:${tag}
      done
