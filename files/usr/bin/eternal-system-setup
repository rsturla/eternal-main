#!/usr/bin/env bash

# Create a hash of files so we can decide if we need to run this script
declare -a HASHED_FILES=(
  "/usr/bin/eternal-system-setup"
  "/usr/lib/systemd/user/eternal-system-setup.service"
  "/etc/eternal/system-setup.d"
)

IS_ERROR=0

CURRENT_HASH=$(sha256sum "${HASHED_FILES[@]}" | sha256sum | awk '{print $1}')
HASH_FILE="/etc/eternal/system-setup/lastrun"

# Execute all scripts in /etc/eteranl/system-setup.d
for script in /etc/eternal/system-setup.d/*; do
  if [[ -x "$script" ]]; then
    if ! "$script"; then
      IS_ERROR=1
    fi
  fi
done

# If there were no errors, update the hash file
if [[ $IS_ERROR -eq 0 ]]; then
  mkdir -p "$(dirname "$HASH_FILE")"
  echo "$CURRENT_HASH" > "$HASH_FILE"
fi

exit $IS_ERROR
