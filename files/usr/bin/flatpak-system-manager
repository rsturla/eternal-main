#!/usr/bin/env bash

# Create hash of files so we can decide if we need to run this script
HASHED_FILES=(
  /etc/flatpak/system/install
  /etc/flatpak/system/remove
  /usr/bin/flatpak-system-manager
  /usr/lib/systemd/system/flatpak-system-manager.service
)
CURRENT_HASH=$(sha256sum ${HASHED_FILES[@]} | sha256sum | awk '{print $1}')
HASH_FILE=/etc/flatpak/lastrun

# Compare hash to last run
if [[ -f $HASH_FILE ]]; then
  PREVIOUS_HASH=$(cat $HASH_FILE)
  if [[ $HASH = $PREVIOUS_HASH ]]; then
    echo "Flatpak manager has already ran. Exiting..."
    exit 0
  fi
fi

# Lists of flatpaks
FLATPAK_LIST=$(flatpak list --columns=application)
INSTALL_LIST=$(cat /etc/flatpak/system/install)
REMOVE_LIST=$(cat /etc/flatpak/system/remove)

# Install flatpaks in list
if [[ -n $INSTALL_LIST ]]; then
  for flatpak in $INSTALL_LIST; do
    if grep -qvz $flatpak <<< $FLATPAK_LIST; then
      flatpak install --system --noninteractive flathub $flatpak
    fi
  done
fi

# Remove flatpaks in list
if [[ -n $REMOVE_LIST ]]; then
  for flatpak in $REMOVE_LIST; do
    if grep -qz $flatpak <<< $FLATPAK_LIST; then
      flatpak remove --system --noninteractive $flatpak
    fi
  done
fi

# Opt out of and remove Fedora's flatpak repo
if grep -qz 'fedora' <<< $(flatpak remotes); then
  /usr/lib/fedora-third-party/fedora-third-party-opt-out
  /usr/bin/fedora-third-party disable
  flatpak remote-delete fedora --force

  FEDORA_FLATPAKS=$(flatpak list --columns=application,origin | grep -w 'fedora' | awk '{print $1}')
  for flatpak in $FEDORA_FLATPAKS; do
    flatpak remove --system --noninteractive $flatpak
  done
fi

echo $HASH > $HASH_FILE
