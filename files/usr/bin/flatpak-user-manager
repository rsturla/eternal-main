#!/usr/bin/env bash

# Create hash of files so we can decide if we need to run this script
HASHED_FILES=(
  /etc/flatpak/user/install
  /etc/flatpak/user/remove
  /usr/bin/flatpak-user-manager
  /usr/lib/systemd/user/flatpak-user-manager.service
)
CURRENT_HASH=$(sha256sum ${HASHED_FILES[@]} | sha256sum | awk '{print $1}')
HASH_FILE=$HOME/.config/flatpak-manager/lastrun

# Compare hash to last run
if [[ -f $HASH_FILE ]]; then
  PREVIOUS_HASH=$(cat $HASH_FILE)
  if [[ $HASH = $PREVIOUS_HASH ]]; then
    echo "Flatpak manager has already ran. Exiting..."
    exit 0
  fi
fi

# Setup Flathub
flatpak remote-add --if-not-exists --user flathub /etc/flatpak/remotes.d/flathub.flatpakrepo

# Lists of flatpaks
FLATPAK_LIST=$(flatpak list --columns=application)
INSTALL_LIST=$(cat /etc/flatpak/user/install)
REMOVE_LIST=$(cat /etc/flatpak/user/remove)

IS_ERROR=0

# Install flatpaks in list
if [[ -n $INSTALL_LIST ]]; then
  for flatpak in $INSTALL_LIST; do
    if grep -qvz $flatpak <<< $FLATPAK_LIST; then
      if ! flatpak install --user --noninteractive flathub $flatpak; then
        IS_ERROR=1
      fi
    fi
  done
fi

# Remove flatpaks in list
if [[ -n $REMOVE_LIST ]]; then
  for flatpak in $REMOVE_LIST; do
    if grep -qz $flatpak <<< $FLATPAK_LIST; then
      if ! flatpak remove --user --noninteractive $flatpak; then
        IS_ERROR=1
      fi
    fi
  done
fi

if [[ $IS_ERROR -eq 0 ]]; then
  echo $CURRENT_HASH > $HASH_FILE
fi
